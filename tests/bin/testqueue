#!/usr/bin/env php
<?php

use \Comodojo\Daemon\Socket\Client;
use \Comodojo\Extender\Task\Request;
use \Comodojo\Extender\Task\TaskParameters;

$base_path = realpath(dirname(__FILE__)."/../../");

$loader = require "$base_path/vendor/autoload.php";

try {

    $client = Client::create('unix://tests/root/run/extender.sock');

    $data = $client->send('queue:addBulk', [
        Request::create(
            'testfail',
            'test',
            new TaskParameters(['sleep'=>10])
        )->setMaxtime(5)->setNiceness(2)->onFail(
            Request::create(
                'testisfailed',
                'test'
            )
        ),
        Request::create(
            'testchain',
            'test'
        )->pipe(
            Request::create(
                'testchainpipe',
                'test'
            )
        )->onDone(
            Request::create(
                'testchaindone',
                'test'
            )->onDone(
                Request::create(
                    'testchainleveltwodone',
                    'test'
                )
            )
        )->onFail(
            Request::create(
                'testchainfail',
                'test'
            )
        )
    ]);

} catch (Exception $e) {

    var_dump($e->getMessage());

    exit(1);

}

var_dump($data);

exit(0);
