#!/usr/bin/env php
<?php

use \Comodojo\Daemon\Socket\Client;
use \Comodojo\Extender\Task\Request;
use \Comodojo\Extender\Task\TaskParameters;

$base_path = realpath(dirname(__FILE__)."/../../");

$loader = require "$base_path/vendor/autoload.php";

try {

    // $client = Client::create('unix://tests/root/run/extender.sock');
    $client = Client::create('tcp://127.0.0.1:10042');

    $name = 'test_sched';
    $data = [];

    $data['scheduler:getByName'] = $client->send('scheduler:getByName', $name);

    if ( $data['scheduler:getByName'] === null ) {

        $request = \Comodojo\Extender\Task\Request::create(
            'testchain',
            'test'
        )->pipe(
            \Comodojo\Extender\Task\Request::create(
                'testchainpipe',
                'test'
            )
        );

        $schedule = new \Comodojo\Extender\Orm\Entities\Schedule();

        $expression = Cron\CronExpression::factory('* * * * *');

        $schedule
            ->setName('test_sched')
            ->setDescription('This is a test')
            ->setRequest($request)
            ->setExpression($expression);

        $data['scheduler:add'] = $client->send('scheduler:add', $schedule);

        // $schedule = $client->send('scheduler:getByName', $name);

    }

    $data['scheduler:enable'] = $client->send('scheduler:enable', $name);

} catch (Exception $e) {

    var_dump($e->getMessage());

    exit(1);

}

var_dump($data);

exit(0);
